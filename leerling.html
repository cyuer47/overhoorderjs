<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Leerling - Overhoorder</title>
    <link rel="stylesheet" href="assets/css/material3.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @supports (view-transition-name: none) {
        html {
          view-transition-name: root;
        }
      }
      
      /* Learner specific styles */
      .question-card {
        background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary));
        color: var(--md-sys-color-on-primary);
        padding: var(--space-xl) var(--space-lg);
        border-radius: var(--md-sys-shape-corner-large);
        text-align: center;
        box-shadow: var(--md-sys-elevation-level3);
        margin-bottom: var(--space-lg);
      }
      
      .score-display {
        background-color: var(--md-sys-color-surface-container);
        padding: var(--space-md);
        border-radius: var(--md-sys-shape-corner-medium);
        text-align: center;
        margin-bottom: var(--space-lg);
        border: 1px solid var(--md-sys-color-outline);
      }
      
      .score-display h3 {
        color: var(--md-sys-color-on-surface);
        margin: 0 0 var(--space-sm) 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      
      .answer-options {
        display: grid;
        gap: var(--space-md);
        margin-top: var(--space-lg);
      }
      
      .answer-option {
        background-color: var(--md-sys-color-surface-container);
        border: 2px solid var(--md-sys-color-outline);
        border-radius: var(--md-sys-shape-corner-medium);
        padding: var(--space-lg);
        cursor: pointer;
        transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-emphasized);
        text-align: center;
        font-weight: 500;
        color: var(--md-sys-color-on-surface);
      }
      
      .answer-option:hover {
        border-color: var(--md-sys-color-primary);
        background-color: var(--md-sys-color-primary-container);
        transform: translateY(-1px);
        box-shadow: var(--md-sys-elevation-level1);
      }
      
      .answer-option.selected {
        border-color: var(--md-sys-color-primary);
        background-color: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
      }
      
      .answer-option.correct {
        border-color: var(--md-sys-color-tertiary);
        background-color: var(--md-sys-color-tertiary-container);
        color: var(--md-sys-color-on-tertiary-container);
      }
      
      .answer-option.incorrect {
        border-color: var(--md-sys-color-error);
        background-color: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
      }
      
      .waiting-state {
        text-align: center;
        padding: var(--space-xl);
        color: var(--md-sys-color-on-surface-variant);
      }
      
      .waiting-state svg {
        animation: float 3s ease-in-out infinite;
      }
      
      .session-ended {
        text-align: center;
        padding: var(--space-xl);
        background-color: var(--md-sys-color-surface-container);
        border-radius: var(--md-sys-shape-corner-medium);
        border: 1px solid var(--md-sys-color-outline);
      }
      
      .progress-bar {
        width: 100%;
        height: 8px;
        background-color: var(--md-sys-color-surface-variant);
        border-radius: var(--md-sys-shape-corner-small);
        overflow: hidden;
        margin: var(--space-md) 0;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-secondary));
        border-radius: var(--md-sys-shape-corner-small);
        transition: width var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-emphasized);
      }
      
      .login-form {
        background-color: var(--md-sys-color-surface-container);
        padding: var(--space-xl);
        border-radius: var(--md-sys-shape-corner-large);
        border: 1px solid var(--md-sys-color-outline);
        max-width: 400px;
        margin: var(--space-xl) auto;
      }
      
      .login-form h2 {
        color: var(--md-sys-color-on-surface);
        margin: 0 0 var(--space-lg) 0;
        text-align: center;
      }
      
      .login-form input {
        width: 100%;
        margin-bottom: var(--space-md);
      }
      
      .login-info {
        text-align: center;
        margin-bottom: var(--space-lg);
        color: var(--md-sys-color-on-surface-variant);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <main class="main-content">
        <div id="app">
          <div class="waiting-state">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); border-radius: var(--md-sys-shape-corner-extra-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg);">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7V12C2 16.5 4.23 20.68 7.62 23.15L12 24L16.38 23.15C19.77 20.68 22 16.5 22 12V7L12 2Z" fill="white" opacity="0.2"/>
                <path d="M12 2L2 7V12C2 16.5 4.23 20.68 7.62 23.15L12 24L16.38 23.15C19.77 20.68 22 16.5 22 12V7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h2 style="color: var(--md-sys-color-on-surface); margin: 0 0 var(--space-sm) 0;">Wachten op overhoring...</h2>
            <p class="helper">Je docent zal binnenkort een vraag sturen</p>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Load identicon utility
      const script = document.createElement('script');
      script.src = 'utils/identicon.js';
      document.head.appendChild(script);

      class LearnerApp {
        constructor() {
          this.sessionId = null;
          this.leerlingId = null;
          this.currentQuestion = null;
          this.score = 0;
          this.totalQuestions = 0;
          this.answeredQuestions = 0;
          this.eventSource = null;
          this.klasInfo = null;
          this.init();
        }

        init() {
          // Check if learner is logged in
          const token = localStorage.getItem("learnerToken");
          if (!token) {
            // Redirect to login page with session ID if available
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            const loginUrl = sessionId ? `leerling_login.html?session=${sessionId}` : 'leerling_login.html';
            window.location = loginUrl;
            return;
          }

          // Get session ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          this.sessionId = urlParams.get('session');
          
          if (!this.sessionId) {
            // Redirect to learner dashboard
            window.location = 'leerling_dashboard.html';
            return;
          }

          this.token = token;
          this.learnerData = JSON.parse(localStorage.getItem('learnerData') || '{}');
          
          // Join session
          this.joinSession();
          
          // Setup SSE connection (no polling!)
          this.setupSSE();
        }

        getOrCreateLearnerId() {
          let learnerId = localStorage.getItem(`learner_${this.sessionId}`);
          if (!learnerId) {
            learnerId = 'learner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(`learner_${this.sessionId}`, learnerId);
          }
          return learnerId;
        }

        async joinSession() {
          try {
            const response = await fetch('/join-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                sessionId: this.sessionId,
                learnerId: this.learnerData?.id || null,
                naam: this.learnerData?.naam || 'Leerling'
              })
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || 'Kon niet deelnemen aan sessie');
            }

            const data = await response.json();
            this.klasInfo = data.klas_info;
            this.learnerData.id = data.learner_id;
            
            // Save learner data
            localStorage.setItem(`learner_${this.sessionId}`, data.learner_id);
            
            console.log('Joined session:', data);
            this.showNotification('Succesvol deelgenomen aan sessie!', 'success');
          } catch (error) {
            console.error('Error joining session:', error);
            this.showNotification(error.message, 'error');
          }
        }

        setupSSE() {
          // Use Server-Sent Events instead of polling
          this.eventSource = new EventSource(`/sessies/${this.sessionId}/stream`);
          
          this.eventSource.onopen = () => {
            console.log('SSE connection opened');
          };

          this.eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleSSEMessage(data);
            } catch (error) {
              console.error('Error parsing SSE message:', error);
            }
          };

          this.eventSource.onerror = (error) => {
            console.error('SSE error:', error);
            // Try to reconnect after delay
            setTimeout(() => {
              if (this.eventSource.readyState === EventSource.CLOSED) {
                this.setupSSE();
              }
            }, 5000);
          };
        }

        handleSSEMessage(data) {
          console.log('SSE message received:', data);

          switch (data.type) {
            case 'question':
              this.showQuestion(data.question);
              break;
            case 'session_ended':
              this.endSession();
              break;
            case 'score_update':
              this.updateScore(data.score);
              break;
            default:
              console.log('Unknown message type:', data.type);
          }
        }

        showQuestion(question) {
          this.currentQuestion = question;
          this.totalQuestions++;
          
          const app = document.getElementById('app');
          
          // Check if it's an open question or multiple choice
          const isOpenQuestion = !question.options || question.options.length === 0;
          
          app.innerHTML = `
            <div class="question-card fade-in">
              <h2 style="margin: 0 0 var(--space-md) 0; font-size: 1.5rem;">Vraag ${this.totalQuestions}</h2>
              <p style="margin: 0; font-size: 1.1rem; line-height: 1.5;">${this.escapeHtml(question.text)}</p>
              ${isOpenQuestion ? '<p class="helper" style="margin-top: var(--space-sm);">Dit is een open vraag. Type je antwoord hieronder.</p>' : ''}
            </div>
            
            <div class="score-display">
              <h3>Score</h3>
              <div style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-primary);">
                ${this.score} / ${this.answeredQuestions}
              </div>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(this.answeredQuestions / Math.max(this.totalQuestions, 1)) * 100}%"></div>
            </div>
            
            <div class="answer-section">
              ${isOpenQuestion ? this.renderOpenQuestion() : this.renderMultipleChoice(question)}
            </div>
          `;
        }

        renderOpenQuestion() {
          return `
            <div class="form-group">
              <textarea 
                id="openAnswer" 
                placeholder="Type je antwoord hier..." 
                rows="4" 
                style="width: 100%; padding: var(--space-md); border: 2px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-medium); background-color: var(--md-sys-color-surface-container-highest); color: var(--md-sys-color-on-surface); font-size: 1rem; resize: vertical; font-family: inherit;"
              ></textarea>
              <button class="btn-primary" onclick="app.submitOpenAnswer()" style="margin-top: var(--space-md); width: 100%;">
                Antwoord Insturen
              </button>
            </div>
          `;
        }

        renderMultipleChoice(question) {
          return `
            <div class="answer-options">
              ${question.options.map((option, index) => `
                <div class="answer-option" data-index="${index}" onclick="app.selectAnswer(${index})">
                  ${this.escapeHtml(option)}
                </div>
              `).join('')}
            </div>
          `;
        }

        submitOpenAnswer() {
          const answerText = document.getElementById('openAnswer').value.trim();
          if (!answerText) {
            this.showError('Voer een antwoord in');
            return;
          }
          
          // Submit the open answer
          this.submitAnswer(answerText);
        }

        selectAnswer(index) {
          if (!this.currentQuestion) return;
          
          const options = document.querySelectorAll('.answer-option');
          options.forEach(opt => opt.classList.remove('selected'));
          options[index].classList.add('selected');
          
          // Submit answer
          this.submitAnswer(index);
        }

        async submitAnswer(answerIndex) {
          try {
            const response = await fetch(`/sessies/${this.sessionId}/answer`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
              },
              body: JSON.stringify({
                leerlingId: this.learnerData.id,
                answerIndex: answerIndex
              })
            });

            if (!response.ok) {
              throw new Error('Kon antwoord niet verzenden');
            }

            const result = await response.json();
            this.answeredQuestions++;
            
            if (result.correct) {
              this.score++;
              this.showAnswerResult(answerIndex, true);
            } else {
              this.showAnswerResult(answerIndex, false);
            }
                
            // Auto-advance to next question after delay
            setTimeout(() => {
              if (this.currentQuestion) {
                this.currentQuestion = null;
                // Clear current question display
                const app = document.getElementById('app');
                app.innerHTML = `
                  <div class="waiting-state">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); border-radius: var(--md-sys-shape-corner-extra-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg);">
                      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7V12C2 16.5 4.23 20.68 7.62 23.15L12 24L16.38 23.15C19.77 20.68 22 16.5 22 12V7L12 2Z" fill="white" opacity="0.2"/>
                        <path d="M12 2L2 7V12C2 16.5 4.23 20.68 7.62 23.15L12 24L16.38 23.15C19.77 20.68 22 16.5 22 12V7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <h2 style="color: var(--md-sys-color-on-surface); margin: 0 0 var(--space-sm) 0;">Wachten op volgende vraag...</h2>
                    <p class="helper">Je docent zal binnenkort een nieuwe vraag sturen</p>
                  </div>
                `;
              }
            }, 2000);
          } catch (error) {
            console.error('Error submitting answer:', error);
            this.showError('Kon antwoord niet verzenden');
          }
        }

        showAnswerResult(answerIndex, correct) {
          const options = document.querySelectorAll('.answer-option');
          const selectedOption = options[answerIndex];
          
          if (correct) {
            selectedOption.classList.add('correct');
          } else {
            selectedOption.classList.add('incorrect');
            // Show correct answer
            if (this.currentQuestion.correctAnswer !== undefined) {
              options[this.currentQuestion.correctAnswer].classList.add('correct');
            }
          }
          
          // Disable all options
          options.forEach(opt => opt.style.pointerEvents = 'none');
        }

        updateScore(newScore) {
          this.score = newScore;
          
          // Update score display if visible
          const scoreDisplay = document.querySelector('.score-display div');
          if (scoreDisplay) {
            scoreDisplay.textContent = `${this.score} / ${this.answeredQuestions}`;
          }
        }

        endSession() {
          if (this.eventSource) {
            this.eventSource.close();
          }
          
          const app = document.getElementById('app');
          app.innerHTML = `
            <div class="session-ended fade-in">
              <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--md-sys-color-tertiary), var(--md-sys-color-primary)); border-radius: var(--md-sys-shape-corner-extra-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg);">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 11L11 14L15 8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <h2 style="color: var(--md-sys-color-on-surface); margin: 0 0 var(--space-md) 0;">Sessie BeÃ«indigd</h2>
              <div style="font-size: 3rem; font-weight: 700; color: var(--md-sys-color-primary); margin: var(--space-lg) 0;">
                ${this.score} / ${this.answeredQuestions}
              </div>
              <p style="color: var(--md-sys-color-on-surface-variant); margin: 0;">
                ${this.answeredQuestions > 0 ? Math.round((this.score / this.answeredQuestions) * 100) : 0}% correct
              </p>
              <div style="margin-top: var(--space-xl);">
                <button class="btn-primary" onclick="window.close()">
                  Sluit Venster
                </button>
              </div>
            </div>
          `;
        }

        showError(message) {
          const app = document.getElementById('app');
          app.innerHTML = `
            <div class="notification error" style="margin: var(--space-lg);">
              ${message}
            </div>
          `;
        }

        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--md-sys-shape-corner-medium);
            color: var(--md-sys-color-on-${type === 'success' ? 'tertiary' : 'surface'});
            background-color: var(--md-sys-color-${type === 'success' ? 'tertiary' : 'surface'});
            border: 1px solid var(--md-sys-color-outline);
            box-shadow: var(--md-sys-elevation-level2);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
          `;
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        escapeHtml(text) {
          if (!text) return '';
          return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }
      }

      // Initialize app
      const app = new LearnerApp();
    </script>
  </body>
</html>
