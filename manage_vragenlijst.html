<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Vragenlijst Beheren - Overhoorder</title>
    <link rel="stylesheet" href="assets/css/material3.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @supports (view-transition-name: none) {
        html {
          view-transition-name: root;
        }
      }
      
      /* Vragenlijst specific styles */
      ul.vraag-lijst {
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
      }
      
      ul.vraag-lijst li {
        background-color: var(--md-sys-color-surface-container);
        padding: var(--space-md);
        border-radius: var(--md-sys-shape-corner-medium);
        border: 1px solid var(--md-sys-color-outline);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
        flex-wrap: wrap;
        transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-emphasized);
      }
      
      ul.vraag-lijst li:hover {
        background-color: var(--md-sys-color-surface-container-high);
        box-shadow: var(--md-sys-elevation-level1);
      }
      
      .vraag-info {
        flex: 1;
        min-width: 200px;
      }
      
      .vraag-text {
        color: var(--md-sys-color-on-surface);
        font-weight: 500;
        margin-bottom: var(--space-xs);
      }
      
      .vraag-meta {
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.875rem;
      }
      
      .vraag-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
      }
      
      .add-vraag-form {
        background-color: var(--md-sys-color-surface-container);
        padding: var(--space-lg);
        border-radius: var(--md-sys-shape-corner-medium);
        border: 1px solid var(--md-sys-color-outline);
        margin-bottom: var(--space-lg);
      }
      
      .option-input {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        margin-bottom: var(--space-sm);
      }
      
      .option-input input {
        flex: 1;
      }
      
      .option-input button {
        padding: var(--space-sm) var(--space-md);
      }
      
      .options-list {
        margin-top: var(--space-md);
      }
      
      .option-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm);
        background-color: var(--md-sys-color-surface-variant);
        border-radius: var(--md-sys-shape-corner-small);
        margin-bottom: var(--space-xs);
      }
      
      .option-item input {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--md-sys-color-on-surface);
      }
      
      .option-item input:focus {
        outline: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="header-content">
          <button class="btn-secondary" onclick="window.location='dashboard.html'">
            <svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor" style="margin-right: var(--space-sm);">
              <path d="m368-417 202 202-90 89-354-354 354-354 90 89-202 202h466v126H368Z"/>
            </svg>
            Terug
          </button>
          <div class="chip">Overhoorder • Vragenlijst Beheer</div>
        </div>
      </header>

      <main class="main-content">
        <div id="app">
          <div class="waiting-state">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); border-radius: var(--md-sys-shape-corner-extra-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); animation: float 3s ease-in-out infinite;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h2 style="color: var(--md-sys-color-on-surface); margin: 0 0 var(--space-sm) 0;">Laden...</h2>
            <p class="helper">Vragenlijst wordt geladen</p>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Load identicon utility
      const script = document.createElement('script');
      script.src = 'utils/identicon.js';
      document.head.appendChild(script);

      class VragenlijstManager {
        constructor() {
          this.vragenlijstId = null;
          this.vragenlijst = null;
          this.token = localStorage.getItem("token");
          this.init();
        }

        init() {
          if (!this.token) {
            window.location = "login.html";
            return;
          }

          // Get vragenlijst ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          this.vragenlijstId = urlParams.get('vragenlijst');
          
          if (!this.vragenlijstId) {
            this.showError('Geen vragenlijst ID gevonden');
            return;
          }

          this.loadVragenlijst();
        }

        async loadVragenlijst() {
          try {
            const response = await fetch(`/vragenlijst/${this.vragenlijstId}`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon vragenlijst niet laden');
            }

            this.vragenlijst = await response.json();
            this.renderVragenlijst();
          } catch (error) {
            console.error('Error loading vragenlijst:', error);
            this.showError('Kon vragenlijst niet laden');
          }
        }

        renderVragenlijst() {
          const app = document.getElementById('app');
          
          app.innerHTML = `
            <div class="fade-in">
              <div class="card-header" style="text-align: center; margin-bottom: var(--space-xl);">
                <h1 style="margin: 0 0 var(--space-sm) 0; color: var(--md-sys-color-on-surface);">${this.escapeHtml(this.vragenlijst.titel)}</h1>
                <p class="helper">${this.vragenlijst.vragen ? this.vragenlijst.vragen.length : 0} vragen</p>
              </div>

              <div class="dashboard-grid">
                <section class="card fade-in">
                  <div class="card-header">
                    <h3>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Nieuwe Vraag Toevoegen
                    </h3>
                  </div>
                  <div class="add-vraag-form">
                    <div class="form-group">
                      <label for="vraagType">Vraag Type</label>
                      <select id="vraagType" onchange="vragenlijstManager.toggleQuestionType()">
                        <option value="meerkeuze">Meerkeuze</option>
                        <option value="open">Open Vraag</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="vraagText">Vraag</label>
                      <textarea id="vraagText" placeholder="Voer je vraag in..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                    
                    <div id="meerkeuzeSection">
                      <div class="form-group">
                        <label>Antwoord Opties</label>
                        <div id="optionsContainer" class="options-list"></div>
                        <div class="option-input">
                          <input type="text" id="newOption" placeholder="Nieuwe optie..." />
                          <button type="button" class="btn-secondary" onclick="vragenlijstManager.addOption()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                      </div>
                    </div>
                    
                    <div id="openSection" style="display: none;">
                      <div class="form-group">
                        <label for="openAnswer">Verwacht Antwoord</label>
                        <input type="text" id="openAnswer" placeholder="Het verwachte antwoord voor de open vraag..." />
                        <p class="helper">Dit wordt gebruikt als referentie voor het nakijken</p>
                      </div>
                      <div class="form-group">
                        <button type="button" class="btn-secondary" onclick="vragenlijstManager.addOpenAnswerOption()">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                          Mogelijk Antwoord Toevoegen
                        </button>
                      </div>
                      <div id="openAnswerOptions" class="options-list"></div>
                    </div>
                    
                    <div class="form-group" id="correctAnswerSection">
                      <label for="correctAnswer">Correct Antwoord</label>
                      <select id="correctAnswer">
                        <option value="">Selecteer correct antwoord...</option>
                      </select>
                    </div>
                    
                    <button type="button" class="btn-primary" onclick="vragenlijstManager.saveVraag()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: var(--space-sm);">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="17 21 17 13 7 13 17 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Vraag Opslaan
                    </button>
                  </div>
                </section>

                <section class="card fade-in" style="animation-delay: 0.1s;">
                  <div class="card-header">
                    <h3>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M9 11H15V21H9V11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 21V7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 3V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Bestaande Vragen
                    </h3>
                  </div>
                  <ul class="vraag-lijst" id="vragenList"></ul>
                </section>
              </div>
            </div>
          `;
          
          this.renderVragen();
          this.initializeOptions();
          this.toggleQuestionType();
        }

        initializeOptions() {
          // Add initial option inputs
          this.addOption();
          this.addOption();
          this.addOption();
          this.addOption();
        }

        addOption() {
          const container = document.getElementById('optionsContainer');
          const optionCount = container.children.length;
          
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option-item';
          optionDiv.innerHTML = `
            <span style="color: var(--md-sys-color-on-surface-variant); font-weight: 500;">${String.fromCharCode(65 + optionCount)}.</span>
            <input type="text" placeholder="Optie ${String.fromCharCode(65 + optionCount)}" onchange="vragenlijstManager.updateCorrectOptions()" />
            <button type="button" class="btn-danger" onclick="this.parentElement.remove(); vragenlijstManager.updateCorrectOptions();" style="padding: var(--space-xs);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
          
          container.appendChild(optionDiv);
          this.updateCorrectOptions();
        }

        addOpenAnswerOption() {
          const container = document.getElementById('openAnswerOptions');
          const optionCount = container.children.length;
          
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option-item';
          optionDiv.innerHTML = `
            <span style="color: var(--md-sys-color-on-surface-variant); font-weight: 500;">Alternatief ${optionCount + 1}:</span>
            <input type="text" placeholder="Mogelijk antwoord..." />
            <button type="button" class="btn-danger" onclick="this.parentElement.remove();" style="padding: var(--space-xs);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
          
          container.appendChild(optionDiv);
        }

        updateCorrectOptions() {
          const select = document.getElementById('correctAnswer');
          const options = document.querySelectorAll('#optionsContainer input');
          
          select.innerHTML = '<option value="">Selecteer correct antwoord...</option>';
          
          options.forEach((input, index) => {
            if (input.value.trim()) {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = `${String.fromCharCode(65 + index)}. ${input.value.trim()}`;
              select.appendChild(option);
            }
          });
        }

        renderVragen() {
          const container = document.getElementById('vragenList');
          
          if (!this.vragenlijst.vragen || this.vragenlijst.vragen.length === 0) {
            container.innerHTML = '<p class="helper">Nog geen vragen toegevoegd</p>';
            return;
          }

          container.innerHTML = '';
          
          this.vragenlijst.vragen.forEach((vraag, index) => {
            const li = document.createElement('li');
            li.style.animationDelay = `${index * 0.05}s`;
            li.className = 'slide-in';
            
            li.innerHTML = `
              <div class="vraag-info">
                <div class="vraag-text">${index + 1}. ${this.escapeHtml(vraag.text)}</div>
                <div class="vraag-meta">
                  ${vraag.vraag_type === 'open' 
                    ? 'Open vraag' 
                    : `${vraag.options?.length || 0} opties • Correct: ${String.fromCharCode(65 + (vraag.correctAnswer || 0))}`
                  }
                </div>
              </div>
              <div class="vraag-actions">
                <button class="btn-secondary" onclick="vragenlijstManager.editVraag(${index})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="btn-danger" onclick="vragenlijstManager.deleteVraag(${index})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            `;
            
            container.appendChild(li);
          });
        }

        toggleQuestionType() {
          const vraagType = document.getElementById('vraagType').value;
          const meerkeuzeSection = document.getElementById('meerkeuzeSection');
          const openSection = document.getElementById('openSection');
          const correctAnswerSection = document.getElementById('correctAnswerSection');
          
          if (vraagType === 'open') {
            meerkeuzeSection.style.display = 'none';
            openSection.style.display = 'block';
            correctAnswerSection.style.display = 'none';
          } else {
            meerkeuzeSection.style.display = 'block';
            openSection.style.display = 'none';
            correctAnswerSection.style.display = 'block';
          }
        }

        async saveVraag() {
          const vraagText = document.getElementById('vraagText').value.trim();
          const vraagType = document.getElementById('vraagType').value;
          
          if (!vraagText) {
            this.showError('Voer een vraag in');
            return;
          }
          
          let options = [];
          let correctAnswer = null;
          
          if (vraagType === 'meerkeuze') {
            options = Array.from(document.querySelectorAll('#optionsContainer input')).map(input => input.value.trim());
            correctAnswer = parseInt(document.getElementById('correctAnswer').value);
            
            if (options.length < 2) {
              this.showError('Voeg minimaal 2 opties toe');
              return;
            }
            
            if (isNaN(correctAnswer) || correctAnswer < 0 || correctAnswer >= options.length) {
              this.showError('Selecteer een correct antwoord');
              return;
            }
          } else {
            // Open vraag
            correctAnswer = document.getElementById('openAnswer').value.trim();
            if (!correctAnswer) {
              this.showError('Voer een verwacht antwoord in');
              return;
            }
          }
          
          try {
            const response = await fetch(`/vragenlijst/${this.vragenlijstId}/vraag`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
              },
              body: JSON.stringify({
                text: vraagText,
                options: options,
                correctAnswer: correctAnswer,
                vraag_type: vraagType
              })
            });

            if (!response.ok) {
              throw new Error('Kon vraag niet opslaan');
            }

            this.showNotification('Vraag opgeslagen', 'success');
            this.clearForm();
            this.loadVragenlijst();
          } catch (error) {
            console.error('Error saving vraag:', error);
            this.showError('Kon vraag niet opslaan');
          }
        }

        async editVraag(index) {
          // For now, just show the question details
          const vraag = this.vragenlijst.vragen[index];
          this.showModal(
            'Vraag Details',
            `
              <div style="text-align: left;">
                <p><strong>Vraag:</strong> ${this.escapeHtml(vraag.text)}</p>
                <p><strong>Opties:</strong></p>
                <ul style="margin: 0; padding-left: var(--space-lg);">
                  ${vraag.options.map((opt, i) => `
                    <li style="${i === vraag.correctAnswer ? 'color: var(--md-sys-color-tertiary); font-weight: 600;' : ''}">
                      ${String.fromCharCode(65 + i)}. ${this.escapeHtml(opt)}
                      ${i === vraag.correctAnswer ? ' ✓' : ''}
                    </li>
                  `).join('')}
                </ul>
              </div>
            `,
            null
          );
        }

        async deleteVraag(index) {
          if (!confirm('Weet je zeker dat je deze vraag wilt verwijderen?')) return;

          try {
            const response = await fetch(`/vragenlijst/${this.vragenlijstId}/vraag/${index}`, {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon vraag niet verwijderen');
            }

            this.showNotification('Vraag verwijderd', 'success');
            this.loadVragenlijst();
          } catch (error) {
            console.error('Error deleting vraag:', error);
            this.showError('Kon vraag niet verwijderen');
          }
        }

        clearForm() {
          document.getElementById('vraagText').value = '';
          document.getElementById('vraagType').value = 'meerkeuze';
          document.getElementById('optionsContainer').innerHTML = '';
          document.getElementById('correctAnswer').innerHTML = '<option value="">Selecteer correct antwoord...</option>';
          document.getElementById('openAnswer').value = '';
          document.getElementById('openAnswerOptions').innerHTML = '';
          this.toggleQuestionType();
          this.initializeOptions();
        }

        showModal(title, content, onConfirm) {
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--md-sys-color-scrim);
            z-index: var(--z-modal-backdrop);
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn var(--md-sys-motion-duration-medium4) var(--md-sys-motion-easing-emphasized);
          `;
          
          modal.innerHTML = `
            <div class="modal-content fade-in" style="
              background-color: var(--md-sys-color-surface-container);
              padding: var(--space-xl);
              border-radius: var(--md-sys-shape-corner-extra-large);
              box-shadow: var(--md-sys-elevation-level5);
              z-index: var(--z-modal);
              max-width: 500px;
              width: 90%;
              max-height: 90vh;
              overflow-y: auto;
            ">
              <h3 style="margin: 0 0 var(--space-md) 0; color: var(--md-sys-color-on-surface);">${title}</h3>
              <div style="margin-bottom: var(--space-lg);">${content}</div>
              <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                <button class="btn-secondary" onclick="this.closest('div[style*=position]').remove()">Sluiten</button>
                ${onConfirm ? '<button class="btn-primary" onclick="vragenlijstManager.confirmModalAction()">Bevestigen</button>' : ''}
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          if (onConfirm) {
            this.pendingAction = onConfirm;
          }
          
          // Add click outside to close
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        confirmModalAction() {
          if (this.pendingAction) {
            this.pendingAction();
            this.pendingAction = null;
          }
          document.querySelector('div[style*=position]').remove();
        }

        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        showError(message) {
          this.showNotification(message, 'error');
        }

        escapeHtml(text) {
          if (!text) return '';
          return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }
      }

      // Initialize vragenlijst manager
      const vragenlijstManager = new VragenlijstManager();
    </script>
  </body>
</html>
