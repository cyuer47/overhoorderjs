<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Klas Beheren - Overhoorder</title>
    <link rel="stylesheet" href="assets/css/material3.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @supports (view-transition-name: none) {
        html {
          view-transition-name: root;
        }
      }
      
      .content-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: var(--space-md);
      }
      
      .content-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .content-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md);
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
        transition: background-color var(--md-sys-motion-duration-short3) var(--md-sys-motion-easing-emphasized);
      }
      
      .content-list li:hover {
        background-color: var(--md-sys-color-surface-container-high);
      }
      
      .content-list li:last-child {
        border-bottom: none;
      }
      
      .delete-btn {
        background-color: var(--md-sys-color-error);
        color: var(--md-sys-color-on-error);
        border: none;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--md-sys-shape-corner-small);
        cursor: pointer;
        font-size: 0.75rem;
        transition: all var(--md-sys-motion-duration-short3) var(--md-sys-motion-easing-emphasized);
      }
      
      .delete-btn:hover {
        background-color: var(--md-sys-color-error-container);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="header-content">
          <button class="btn-secondary" onclick="window.location.href='dashboard.html'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: var(--space-sm);">
              <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Terug
          </button>
          <div class="chip">Overhoorder â€¢ Klas Beheren</div>
        </div>
      </header>

      <main class="main-content">
        <div id="app">
          <div class="loading-state">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); border-radius: var(--md-sys-shape-corner-extra-large); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); animation: float 3s ease-in-out infinite;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" fill="white" opacity="0.2"/>
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h2 style="color: var(--md-sys-color-on-surface); margin: 0 0 var(--space-sm) 0;">Laden...</h2>
            <p class="helper">Klas informatie wordt geladen</p>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Load identicon utility
      const script = document.createElement('script');
      script.src = 'utils/identicon.js';
      document.head.appendChild(script);

      class ClassManager {
        constructor() {
          this.token = localStorage.getItem("token");
          this.klasId = null;
          this.klas = null;
          this.init();
        }

        init() {
          if (!this.token) {
            window.location = "login.html";
            return;
          }

          // Get klas ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          this.klasId = urlParams.get('klas');
          
          if (!this.klasId) {
            this.showError('Geen klas ID gevonden');
            return;
          }

          this.loadKlasInfo();
        }

        async loadKlasInfo() {
          try {
            const response = await fetch(`/klas/${this.klasId}`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon klas informatie niet laden');
            }

            const data = await response.json();
            this.klas = data.klas;
            this.renderKlasInfo();
            this.loadLeerlingen();
            this.loadVragenlijsten();
            this.loadSessies();
          } catch (error) {
            console.error('Error loading klas info:', error);
            this.showError('Kon klas informatie niet laden');
          }
        }

        renderKlasInfo() {
          const app = document.getElementById('app');
          app.innerHTML = `
            <div class="dashboard-grid">
              <section class="card fade-in">
                <div class="card-header">
                  <h3>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Klas Informatatie
                  </h3>
                </div>
                <div class="form-group">
                  <label for="klasNaam">Klas Naam</label>
                  <input type="text" id="klasNaam" value="${this.escapeHtml(this.klas.naam)}" />
                </div>
                <div class="form-group">
                  <label for="vak">Vak</label>
                  <input type="text" id="vak" value="${this.escapeHtml(this.klas.vak || '')}" />
                </div>
                <div class="form-group">
                  <label for="klascode">Klascode</label>
                  <input type="text" id="klascode" value="${this.escapeHtml(this.klas.klascode)}" readonly style="background-color: var(--md-sys-color-surface-container-highest) !important;" />
                  <p class="helper">Deze code gebruiken leerlingen om deel te nemen</p>
                </div>
                <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
                  <button class="btn-primary" onclick="classManager.saveKlasInfo()">
                    Opslaan
                  </button>
                  <button class="btn-danger" onclick="classManager.deleteKlas()">
                    Klas Verwijderen
                  </button>
                </div>
              </section>

              <section class="card fade-in" style="animation-delay: 0.1s;">
                <div class="card-header">
                  <h3>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Leerlingen
                  </h3>
                </div>
                <div id="leerlingenSection">
                  <div class="form-group">
                    <p class="helper">Leerlingen kunnen deelnemen via de klascode of door registratie</p>
                  </div>
                  <div id="leerlingenList" class="content-list"></div>
                </div>
              </section>

              <section class="card fade-in" style="animation-delay: 0.2s;">
                <div class="card-header">
                  <h3>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Vragenlijsten
                  </h3>
                </div>
                <div id="vragenlijstenSection">
                  <div class="form-group">
                    <input type="text" id="newVragenlijstNaam" placeholder="Nieuwe vragenlijst naam..." style="margin-bottom: var(--space-sm);" />
                    <button class="btn-primary" onclick="classManager.addCustomVragenlijst()">
                      Custom Vragenlijst Toevoegen
                    </button>
                  </div>
                  <div id="vragenlijstenList" class="content-list"></div>
                </div>
              </section>

              <section class="card fade-in" style="animation-delay: 0.3s;">
                <div class="card-header">
                  <h3>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                      <path d="M9 11H15V21H9V11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M3 21V7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 3V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Sessie Geschiedenis
                  </h3>
                </div>
                <div id="sessiesList" class="content-list"></div>
              </section>
            </div>
          `;
        }

        async loadLeerlingen() {
          try {
            const response = await fetch(`/klas/${this.klasId}/leerlingen`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon leerlingen niet laden');
            }

            const data = await response.json();
            this.renderLeerlingen(data.leerlingen);
          } catch (error) {
            console.error('Error loading leerlingen:', error);
          }
        }

        renderLeerlingen(leerlingen) {
          const container = document.getElementById('leerlingenList');
          
          if (!leerlingen || leerlingen.length === 0) {
            container.innerHTML = '<p class="helper">Nog geen leerlingen</p>';
            return;
          }

          const ul = document.createElement('ul');
          leerlingen.forEach((leerling, index) => {
            const li = document.createElement('li');
            li.style.animationDelay = `${index * 0.05}s`;
            li.className = 'slide-in';
            li.innerHTML = `
              <span>${this.escapeHtml(leerling.naam)}</span>
              <button class="delete-btn" onclick="classManager.deleteLeerling(${leerling.id})">
                Verwijderen
              </button>
            `;
            ul.appendChild(li);
          });
          
          container.innerHTML = '';
          container.appendChild(ul);
        }

        async loadVragenlijsten() {
          try {
            const response = await fetch(`/klas/${this.klasId}`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon vragenlijsten niet laden');
            }

            const data = await response.json();
            this.renderVragenlijsten(data.vragenlijsten);
          } catch (error) {
            console.error('Error loading vragenlijsten:', error);
          }
        }

        renderVragenlijsten(vragenlijsten) {
          const container = document.getElementById('vragenlijstenList');
          
          if (!vragenlijsten || vragenlijsten.length === 0) {
            container.innerHTML = '<p class="helper">Nog geen vragenlijsten</p>';
            return;
          }

          const ul = document.createElement('ul');
          vragenlijsten.forEach((vragenlijst, index) => {
            const li = document.createElement('li');
            li.style.animationDelay = `${index * 0.05}s`;
            li.className = 'slide-in';
            li.innerHTML = `
              <span>${this.escapeHtml(vragenlijst.naam)} ${vragenlijst.is_custom ? '(Custom)' : ''}</span>
              <div>
                <button class="btn-secondary" style="font-size: 0.75rem; padding: var(--space-xs) var(--space-sm); margin-right: var(--space-xs);" onclick="classManager.manageVragenlijst(${vragenlijst.id})">
                  Beheren
                </button>
                <button class="delete-btn" onclick="classManager.deleteVragenlijst(${vragenlijst.id})">
                  Verwijderen
                </button>
              </div>
            `;
            ul.appendChild(li);
          });
          
          container.innerHTML = '';
          container.appendChild(ul);
        }

        async loadSessies() {
          try {
            const response = await fetch(`/klas/${this.klasId}/sessies`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon sessies niet laden');
            }

            const data = await response.json();
            this.renderSessies(data.sessies);
          } catch (error) {
            console.error('Error loading sessies:', error);
          }
        }

        renderSessies(sessies) {
          const container = document.getElementById('sessiesList');
          
          if (!sessies || sessies.length === 0) {
            container.innerHTML = '<p class="helper">Nog geen sessies</p>';
            return;
          }

          const ul = document.createElement('ul');
          sessies.forEach((sessie, index) => {
            const li = document.createElement('li');
            li.style.animationDelay = `${index * 0.05}s`;
            li.className = 'slide-in';
            li.innerHTML = `
              <div>
                <strong>${this.escapeHtml(sessie.vragenlijst_naam || 'Onbekend')}</strong>
                <div style="font-size: 0.875rem; color: var(--md-sys-color-on-surface-variant);">
                  ${new Date(sessie.started_at).toLocaleString()}
                </div>
              </div>
              <button class="btn-secondary" style="font-size: 0.75rem; padding: var(--space-xs) var(--space-sm);" onclick="classManager.viewSessie(${sessie.id})">
                Bekijken
              </button>
            `;
            ul.appendChild(li);
          });
          
          container.innerHTML = '';
          container.appendChild(ul);
        }

        async saveKlasInfo() {
          try {
            const klasNaam = document.getElementById('klasNaam').value.trim();
            const vak = document.getElementById('vak').value.trim();

            const response = await fetch(`/klas/${this.klasId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
              },
              body: JSON.stringify({ naam: klasNaam, vak })
            });

            if (!response.ok) {
              throw new Error('Kon klas informatie niet opslaan');
            }

            this.showNotification('Klas informatie opgeslagen', 'success');
            this.klas.naam = klasNaam;
            this.klas.vak = vak;
          } catch (error) {
            console.error('Error saving klas info:', error);
            this.showError('Kon klas informatie niet opslaan');
          }
        }

        async addCustomVragenlijst() {
          const naamInput = document.getElementById('newVragenlijstNaam');
          const naam = naamInput.value.trim();
          
          if (!naam) {
            this.showError('Voer een naam in voor de vragenlijst');
            return;
          }

          try {
            const response = await fetch('/vragenlijst', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
              },
              body: JSON.stringify({ 
                naam: naam,
                klas_id: this.klasId,
                is_custom: true
              })
            });

            if (!response.ok) {
              throw new Error('Kon vragenlijst niet toevoegen');
            }

            this.showNotification('Vragenlijst toegevoegd', 'success');
            naamInput.value = '';
            this.loadVragenlijsten();
          } catch (error) {
            console.error('Error adding vragenlijst:', error);
            this.showError('Kon vragenlijst niet toevoegen');
          }
        }

        async deleteLeerling(leerlingId) {
          if (!confirm('Weet je zeker dat je deze leerling wilt verwijderen?')) {
            return;
          }

          try {
            const response = await fetch(`/leerling/${leerlingId}`, {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon leerling niet verwijderen');
            }

            this.showNotification('Leerling verwijderd', 'success');
            this.loadLeerlingen();
          } catch (error) {
            console.error('Error deleting leerling:', error);
            this.showError('Kon leerling niet verwijderen');
          }
        }

        async deleteVragenlijst(vragenlijstId) {
          if (!confirm('Weet je zeker dat je deze vragenlijst wilt verwijderen? Alle vragen worden ook verwijderd.')) {
            return;
          }

          try {
            const response = await fetch(`/vragenlijst/${vragenlijstId}`, {
              method: 'DELETE',
              headers: { Authorization: `Bearer ${this.token}` }
            });

            if (!response.ok) {
              throw new Error('Kon vragenlijst niet verwijderen');
            }

            this.showNotification('Vragenlijst verwijderd', 'success');
            this.loadVragenlijsten();
          } catch (error) {
            console.error('Error deleting vragenlijst:', error);
            this.showError('Kon vragenlijst niet verwijderen');
          }
        }

        async deleteKlas() {
          if (!confirm('Weet je zeker dat je deze klas wilt verwijderen? Alle leerlingen, vragenlijsten en resultaten worden ook verwijderd.')) {
            return;
          }

          try {
            const response = await fetch(`/delete-klas`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
              },
              body: JSON.stringify({ klas_id: this.klasId })
            });

            if (!response.ok) {
              throw new Error('Kon klas niet verwijderen');
            }

            this.showNotification('Klas verwijderd', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 2000);
          } catch (error) {
            console.error('Error deleting klas:', error);
            this.showError('Kon klas niet verwijderen');
          }
        }

        manageVragenlijst(vragenlijstId) {
          window.location.href = `manage_vragenlijst.html?vragenlijst=${vragenlijstId}`;
        }

        viewSessie(sessieId) {
          window.location.href = `vraag_handler.html?session=${sessieId}`;
        }

        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        showError(message) {
          this.showNotification(message, 'error');
        }

        escapeHtml(text) {
          if (!text) return '';
          return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }
      }

      // Initialize class manager
      const classManager = new ClassManager();
    </script>
  </body>
</html>
